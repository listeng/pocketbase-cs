<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="UTF-8" />
        <title>-</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
        <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" />
        <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
        <link href="./js/amis@6.8/sdk/sdk.css" rel="stylesheet" title="default" />
        <link href="./js/amis@6.8/sdk/helper.css" rel="stylesheet" />
        <link href="./js/amis@6.8/sdk/iconfont.css" rel="stylesheet" />
        <link href="./js/amis@6.8/sdk/cxd.css" rel="stylesheet" />
        <script src="./js/amis@6.8/sdk/sdk.js"></script>
        <script src="./js/history@5.3.0/umd/history.production.min.js"></script>
        <style>
            html,
            body,
            .app-wrapper {
                position: relative;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        <div class="app-wrapper" id="root"></div>
        <script>
            function getUrlParams(url) {
                // 如果没有传入URL，就使用当前页面的URL
                const urlString = url || window.location.href;
                let paramString = urlString.split("?")[1];
                const searchParams = new URLSearchParams(paramString);

                let paramObj = {};
                for (let pair of searchParams.entries()) {
                    // 如果参数出现多次，使用数组存储所有值
                    if (paramObj.hasOwnProperty(pair[0])) {
                        if (Array.isArray(paramObj[pair[0]])) {
                            paramObj[pair[0]].push(pair[1]);
                        } else {
                            paramObj[pair[0]] = [paramObj[pair[0]], pair[1]];
                        }
                    } else {
                        paramObj[pair[0]] = pair[1];
                    }
                }

                return paramObj;
            }

            function getPbFilterParams(url, fields) {
                const urlString = url;
                let paramString = urlString.split("?")[1];
                const searchParams = new URLSearchParams(paramString);

                let paramObj = {};
                for (let pair of searchParams.entries()) {
                    if (pair[0].indexOf("pbf_") !== 0) {
                        continue;
                    }

                    pair[0] = pair[0].substring(4);

                    if (pair[0] === "keyword" && fields && fields.length > 0) {
                        const keywordConditions = fields.map((field) => `${field}~'${pair[1]}'`);
                        paramObj[pair[0]] = `(${keywordConditions.join(" || ")})`;
                    } else if (paramObj.hasOwnProperty(pair[0])) {
                        if (Array.isArray(paramObj[pair[0]])) {
                            paramObj[pair[0]].push(pair[1]);
                        } else {
                            paramObj[pair[0]] = [paramObj[pair[0]], pair[1]];
                        }
                    } else {
                        paramObj[pair[0]] = pair[1];
                    }
                }

                return paramObj;
            }

            function buildKeywordFilter(url, fields) {
                const filter = buildPocketBaseFilter(getPbFilterParams(url, fields));
                if (url.indexOf("?") > 0) {
                    url += "&filter=" + encodeURIComponent(filter);
                } else {
                    url += "?filter=" + encodeURIComponent(filter);
                }

                return url;
            }

            function buildPocketBaseFilter(params) {
                const filters = [];
                for (const [key, value] of Object.entries(params)) {
                    if (value !== undefined && value !== null && value !== "") {
                        if (key == "keyword") {
                            filters.push(`${value}`);
                        } else if (typeof value === "boolean" || value === "true" || value === "false") {
                            filters.push(`${key}=${value}`);
                        } else if (typeof value === "string") {
                            filters.push(`${key}~'${value}'`);
                        } else if (typeof value === "number") {
                            filters.push(`${key}=${value}`);
                        }
                    }
                }
                return filters.length > 0 ? `(${filters.join(" && ")})` : "";
            }

            function getAuthToken() {
                const pb_admin_token = localStorage.getItem("pb_admin_auth");
                if (pb_admin_token) {
                    try {
                        return JSON.parse(pb_admin_token).token;
                    } catch {}
                }

                const pb_token = localStorage.getItem("pb_token");
                if (pb_token) {
                    return pb_token;
                }

                return null;
            }

            (function () {
                let amis = amisRequire("amis/embed");
                const match = amisRequire("path-to-regexp").match;

                // 如果想用 browserHistory 请切换下这处代码, 其他不用变
                // const history = HistoryLibrary.createBrowserHistory();
                const history = HistoryLibrary.createHashHistory();

                window.enableAMISDebug = true;

                function normalizeLink(to, location = history.location) {
                    to = to || "";

                    if (to && to[0] === "#") {
                        to = location.pathname + location.search + to;
                    } else if (to && to[0] === "?") {
                        to = location.pathname + to;
                    }

                    const idx = to.indexOf("?");
                    const idx2 = to.indexOf("#");
                    let pathname = ~idx ? to.substring(0, idx) : ~idx2 ? to.substring(0, idx2) : to;
                    let search = ~idx ? to.substring(idx, ~idx2 ? idx2 : undefined) : "";
                    let hash = ~idx2 ? to.substring(idx2) : location.hash;

                    if (!pathname) {
                        pathname = location.pathname;
                    } else if (pathname[0] != "/" && !/^https?\:\/\//.test(pathname)) {
                        let relativeBase = location.pathname;
                        const paths = relativeBase.split("/");
                        paths.pop();
                        let m;
                        while ((m = /^\.\.?\//.exec(pathname))) {
                            if (m[0] === "../") {
                                paths.pop();
                            }
                            pathname = pathname.substring(m[0].length);
                        }
                        pathname = paths.concat(pathname).join("/");
                    }

                    return pathname + search + hash;
                }

                function isCurrentUrl(to, ctx) {
                    if (!to) {
                        return false;
                    }
                    const pathname = history.location.pathname;
                    const link = normalizeLink(to, {
                        ...location,
                        pathname,
                        hash: "",
                    });

                    if (!~link.indexOf("http") && ~link.indexOf(":")) {
                        let strict = ctx && ctx.strict;
                        return match(link, {
                            decode: decodeURIComponent,
                            strict: typeof strict !== "undefined" ? strict : true,
                        })(pathname);
                    }

                    return decodeURI(pathname) === link;
                }

                function getPageData(id) {
                    const authToken = getAuthToken();
                    const headers = {};
                    if (authToken) {
                        headers["Authorization"] = authToken;
                    }
                    fetch("/pb-proxy/api/collections/Page/records/" + id, { headers: headers })
                        .then((response) => response.json())
                        .then((data) => {
                            document.title = data.remark;

                            let amisInstance = amis.embed(
                                "#root",
                                data.config,
                                {
                                    location: history.location,
                                    data: {
                                        // 全局数据，是受控的数据
                                    },
                                    context: {},
                                },
                                {
                                    requestAdaptor: (api) => {
                                        api.headers = api.headers || {};
                                        api.headers["Authorization"] = getAuthToken();

                                        return api;
                                    },

                                    responseAdaptor: (api, payload, query, request, response) => {
                                        if (request.url.indexOf("auth-with-password") > 0) {
                                            return payload;
                                        } else {
                                            return {
                                                status: payload.code || 0,
                                                msg: payload.messages || "",
                                                data: {
                                                    items: payload.items,
                                                    total: payload.totalItems,
                                                },
                                            };
                                        }
                                    },

                                    updateLocation: (location, replace) => {
                                        location = normalizeLink(location);
                                        if (location === "goBack") {
                                            return history.goBack();
                                        } else if (
                                            (!/^https?\:\/\//.test(location) &&
                                                location ===
                                                    history.location.pathname + history.location.search) ||
                                            location === history.location.href
                                        ) {
                                            // 目标地址和当前地址一样，不处理，免得重复刷新
                                            return;
                                        } else if (/^https?\:\/\//.test(location) || !history) {
                                            return (window.location.href = location);
                                        }

                                        history[replace ? "replace" : "push"](location);
                                    },
                                    jumpTo: (to, action) => {
                                        console.log(to);

                                        if (to === "goBack") {
                                            return history.goBack();
                                        }

                                        to = normalizeLink(to);

                                        if (isCurrentUrl(to)) {
                                            return;
                                        }

                                        if (action && action.actionType === "url") {
                                            action.blank === false
                                                ? (window.location.href = to)
                                                : window.open(to, "_blank");
                                            return;
                                        } else if (action && action.blank) {
                                            window.open(to, "_blank");
                                            return;
                                        }

                                        if (/^https?:\/\//.test(to)) {
                                            window.location.href = to;
                                        } else if (
                                            (!/^https?\:\/\//.test(to) &&
                                                to === history.pathname + history.location.search) ||
                                            to === history.location.href
                                        ) {
                                            // do nothing
                                        } else {
                                            history.push(to);
                                        }
                                    },
                                    isCurrentUrl: isCurrentUrl,
                                    theme: "cxd",
                                }
                            );

                            history.listen((state) => {
                                amisInstance.updateProps({
                                    location: state.location || state,
                                });
                            });
                        })
                        .catch((error) => {
                            console.error("获取数据时出错:", error);
                        });
                }

                getPageData(getUrlParams().id);
            })();
        </script>
    </body>
</html>
